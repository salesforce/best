# Continuous Integration

Continuous integration is the best place to invoke Best. It is
recommended to run your CI and Best on all commits into `main`
and on all pull requests (PR) so you have visibility into the
performance profile of your code whenever it changes.

## Pull Requests

We recommend running Best two ways on every PR:

1. `best` Run your benchmarks on your current code to measure
   its performance.
1. `best --compareStats` Run Best in comparison mode with the
   current code compared against the target branch.

Running Best a second time in comparison mode generates a comparison
table, which can be shown on the pull request using the [GitHub
Integration](../github-integration/).

When you run Best in comparison mode you ensure the same environment
is used for the two executions. This reduces inconsistencies caused
by extraneous variables.

## Commits to `main`

When you run your CI after a new commit to `main`, we recommend running
Best again so the results are stored and visible on [the front
end](../frontend/). This allows you to see a graph of your code's
performance over time with each change in `main`.

There is no need to run Best in comparison mode because you aren't
comparing against a separate branch.

## Example in CircleCI

To see an example, look at Best's own CircleCI
[`config.yml`](https://github.com/salesforce/best/blob/main/.circleci/config.yml).
Look at the `perf_and_compare` job to see how Best is used to benchmark
Best. The relevant commands are copied below.

```yml
- run:
      name: Run BEST Benchmarks
      command: yarn perf
- run:
      name: Compare BEST Benchmarks
      command: yarn perf --compareStats ${BASE_COMMIT} ${TARGET_COMMIT} --gitIntegration
```

The Yarn command `perf` is essentially an alias to the Best CLI. Best
is first run to benchmark the code of the new Pull Request. Then
`best --compareStats` is run with a base commit from `main` and a target
commit from the PR. The `--gitIntegration` flag causes Best to post the
results on the pull request on GitHub.

?> To guarantee reproducible results, we **highly** recommend using
   a remote runner for your benchmarks. Check out the guide on [running
   remotely](../running-remotely/).

## External Storage

When running Best in your CI workflow, we recommend using an external
storage provider for the artifacts generated by Best. This avoids
rebuilding the benchmark results to run the comparison. Best supports
storing the artifacts on AWS.

To use an external storage provider, pass the `--externalStorage` flag:

```sh
best --compareStats ${BASE_COMMIT} ${TARGET_COMMIT} 
```

You must also set the `AWS_BUCKET_NAME` environment variable so Best
knows where to find your artifacts. The bucket must be publicly
accessible so that Best can read and write into it.

!> To use a [remote runner](../running-remotely) to run your benchmarks
   you must use external storage.
